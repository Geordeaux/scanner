# schema: https://scanner.dev/schema/scanner-threat-hunting-query.v1.json
name: GCP Service Account Key Used From Multiple Countries
description: |-
  Detect when a Google Cloud service account key is used from multiple countries. This behavior may indicate unauthorized or malicious access to the service account, as legitimate use typically originates from a single location.
query_text: |-
  %ingest.source_type:gcp
  protoPayload.authenticationInfo.serviceAccountKeyName:*
  protoPayload.requestMetadata.callerIp_geo.country:*
  (not protoPayload.requestMetadata.callerIp_geo.organization:"Google")
  | groupbycount(protoPayload.authenticationInfo.serviceAccountKeyName, protoPayload.requestMetadata.callerIp_geo.country)
  | where @q.count_distinct_protoPayload_requestMetadata_callerIp_geo_country > 2
tags:
- source.gcp
- gcp
- gcp_iam
- gcp_audit
- service_account_key_multiple_countries
- techniques.t1552.unsecured_credentials
- tactics.ta0006.credential_access
