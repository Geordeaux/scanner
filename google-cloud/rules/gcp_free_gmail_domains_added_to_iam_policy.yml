# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: GCP Free Gmail Domains Added To IAM Policy
description: |-
  ## Goal
  Detect when free Google email addresses (e.g., gmail.com, googlemail.com, or googlegroups.com) are added to an IAM policy. This can indicate an attempt to gain unauthorized access by adding external, non-corporate accounts to the organization's IAM policies.

  ## Strategy
  Monitor GCP Cloud Audit logs for events where an IAM policy is updated to include members with email addresses from free Google domains. Capture relevant details such as the principal IP, user, and target resource to assess potential threats. Set a high risk score to indicate the severity of this event.

  ## Triage and Response
  Investigate the detected event to determine if it was authorized. Review the principal IPs, users, and other details to ensure that no unauthorized actions have been taken. Ensure that all IAM policies are compliant with company policies.

enabled: true
severity: High

query_text: |-
  %ingest.source_type:gcp_audit
  metadata.event_type:"USER_RESOURCE_UPDATE_PERMISSIONS"
  metadata.log_type:"GCP_CLOUDAUDIT"
  metadata.product_event_type:"SetIamPolicy"
  metadata.vendor_name:"Google Cloud Platform"
  security_result.action:"ALLOW"
  target.resource.attribute.labels.service_binding_deltas_action:"ADD"

time_range_s: 3600
run_frequency_s: 300

event_sink_keys:
  - high_severity_alerts

tags:
  - source.gcp
  - gcp_audit
  - gcp
  - iam_policy
  - iam_policy_violation
  - techniques.t1136.create_account
  - tactics.ta0003.persistence

# Additional context fields for alert graph
context_fields:
  - network.http.user_agent
  - principal.ip
  - principal.ip_geo_artifact.location.country_or_region
  - principal.ip_geo_artifact.location.state
  - principal.user.display_name
  - target.resource.name

# Outcome variables
risk_score: 75

event_count: count_distinct(gcp.metadata.id)

network_http_user_agent: array_distinct(gcp.network.http.user_agent)
principal_ip: array_distinct(gcp.principal.ip)
principal_ip_country: array_distinct(gcp.principal.ip_geo_artifact.location.country_or_region)
principal_ip_state: array_distinct(gcp.principal.ip_geo_artifact.location.state)

principal_user_id: gcp.principal.user.userid
principal_user_display_name: gcp.principal.user.display_name

target_resource_name: gcp.target.resource.name
event_name: gcp.metadata.product_event_type
target_email_addresses: array_distinct(gcp.target.user.email_addresses)

# Condition
condition:
  - metadata.event_type = "USER_RESOURCE_UPDATE_PERMISSIONS"
  - metadata.log_type = "GCP_CLOUDAUDIT"
  - metadata.product_event_type = "SetIamPolicy"
  - metadata.vendor_name = "Google Cloud Platform"
  - security_result.action = "ALLOW"
  - target.resource.attribute.labels.service_binding_deltas_action = "ADD"
  - target.resource.attribute.labels.service_binding_deltas_member =~ /(.*@gmail\.com|.*@googlemail\.com|.*@googlegroups\.com)/ nocase