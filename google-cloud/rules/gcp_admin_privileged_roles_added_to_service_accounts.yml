# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: GCP Admin Privileged Roles Added To Service Accounts
description: |-
  ## Goal
  Detect when admin privileged roles such as Owner or Editor are added to a Service Account. This could indicate an attempt to escalate privileges, which is a common tactic used by adversaries for persistence and privilege escalation.

  ## Strategy
  Monitor GCP Cloud Audit logs for events where the `SetIamPolicy` action is taken on service accounts with roles like `roles/owner` or `roles/editor`. Capture relevant details such as the principal IP, user, and target resource to assess potential threats.

  ## Triage and Response
  Investigate the detected event to determine if it was authorized. Review the principal IPs, users, and other details to ensure that no unauthorized privilege escalation has occurred. Ensure that all role assignments comply with company policies.

enabled: true
severity: Low

query_text: |-
  %ingest.source_type:gcp_audit
  metadata.event_type:USER_RESOURCE_UPDATE_PERMISSIONS
  metadata.log_type:GCP_CLOUDAUDIT
  metadata.product_event_type:SetIamPolicy
  security_result.action:ALLOW
  target.resource.attribute.labels.ser_binding_deltas_action:ADD
  (
    target.resource.attribute.labels.ser_binding_deltas_role:"roles/owner" or
    target.resource.attribute.labels.ser_binding_deltas_role:"roles/editor"
  )
  target.resource.attribute.labels.ser_binding_deltas_member:serviceAccount

time_range_s: 3600
run_frequency_s: 300

event_sink_keys:
  - low_severity_alerts

tags:
  - source.gcp
  - gcp_audit
  - role_assignment
  - techniques.t1098.account_manipulation
  - tactics.ta0003.persistence
  - tactics.ta0004.privilege_escalation

# Additional context fields for enrichment + graph paths
context_fields:
  - network.http.user_agent
  - principal.ip
  - principal.ip_geo_artifact.location.country_or_region
  - principal.ip_geo_artifact.location.state
  - target.resource.name


# Outcome variables
risk_score: max(35)

event_count: count_distinct(metadata.id)

network_http_user_agent: array_distinct(network.http.user_agent)
principal_ip: array_distinct(principal.ip)
principal_ip_country: array_distinct(principal.ip_geo_artifact.location.country_or_region)
principal_ip_state: array_distinct(principal.ip_geo_artifact.location.state)

principal_user_id: principal.user.userid
principal_user_display_name: principal.user.user_display_name

target_resource_name: target.resource.name
event_name: metadata.product_event_type
target_email_addresses: array_distinct(target.user.email_addresses)

# Detection condition (CEL)
condition: event_count > 0