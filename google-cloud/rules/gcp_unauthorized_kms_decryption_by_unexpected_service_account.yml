# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: Unauthorized KMS Decryption by Unexpected Service Account
description: |-
  ## Goal
  Detect when a Key Management Service (KMS) decryption operation is carried out by a service account that is not in the allowlist. This may indicate unauthorized access.

  ## Strategy
  Monitor GCP Cloud Audit Logs for `Decrypt` operations and alert when the requesting
  principal is NOT in the explicitly configured allowlist below.

  ## Triage and Response
  1. Identify the service account performing the decrypt.
  2. Confirm whether the service account *should* have decryption permissions.
  3. Rotate keys if unauthorized activity is found.
  4. Investigate related suspicious behaviors.

enabled: true
severity: Medium

query_text: |-
  %ingest.source_type:gcp_audit_log
  metadata.log_type:GCP_CLOUDAUDIT
  metadata.product_event_type:"Decrypt"
  target.application:"cloudkms.googleapis.com"
  not principal.user.email_addresses:(
    allowed-sa-1@project.iam.gserviceaccount.com
    allowed-sa-2@project.iam.gserviceaccount.com
  )

time_range_s: 86400      # 24 hours
run_frequency_s: 300      # every 5 minutes

event_sink_keys:
  - kms_decryption_alerts

tags:
  - gcp_audit_log
  - kms
  - unauthorized_kms_decryption
  - techniques.t1078.valid_accounts
  - tactics.ta0006.credential_access

context_fields:
  - metadata.product_event_type
  - principal.user.email_addresses
  - principal.ip
  - principal.ip_geo_artifact.location.country_or_region
  - principal.ip_geo_artifact.location.state
  - target.resource.name

risk_score: 50
event_count: count_distinct(metadata.id)

condition:
  - true