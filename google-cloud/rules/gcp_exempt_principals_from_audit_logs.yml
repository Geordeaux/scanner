# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: GCP Exempt Principals From Audit Log
description: |-
  ## Goal
  Detect when GCP Cloud Audit logs are exempted for principals in all services at the project or organization level. This can indicate an attempt to evade monitoring and auditing by disabling audit logging for specific users or groups.

  ## Strategy
  Monitor GCP Cloud Audit logs for events where the `SetIamPolicy` action is taken to exempt principals from audit logging in all services (`allServices`). Capture relevant details such as the principal IP, user, and target resource to assess potential threats. Increase the risk score if the exemption is at the organization level.

  ## Triage and Response
  Investigate the detected event to determine if it was authorized. Review the principal IPs, users, and other details to ensure that no unauthorized actions have been taken. Ensure that all audit logging policies are compliant with company policies.

enabled: true
severity: High

query_text: |-
  %ingest.source_type:gcp_audit
  metadata.event_type:USER_RESOURCE_UPDATE_PERMISSIONS
  metadata.log_type:GCP_CLOUDAUDIT
  metadata.product_event_type:SetIamPolicy
  security_result.action:ALLOW
  target.application:cloudresourcemanager.googleapis.com
  target.resource.attribute.labels.service_data_policy_delta_audit_config_delta_exempted_member_action:ADD
  target.resource.attribute.labels.service_data_policy_delta_audit_config_delta_exempted_member_service:allServices

time_range_s: 3600
run_frequency_s: 300

event_sink_keys:
  - high_severity_alerts

tags:
  # Source / platform
  - source.gcp
  - gcp_audit
  - cloud_audit

  # Detection-specific
  - audit_log_exemption

  # MITRE ATT&CK alignment (match Scanner style)
  - techniques.t1562.impair_defenses_disable_cloud_logs
  - tactics.ta0005.defense_evasion

# Additional context fields for alert graph
context_fields:
  - network.http.user_agent
  - principal.ip
  - principal.ip_geo_artifact.location.country_or_region
  - principal.ip_geo_artifact.location.state
  - principal.user.user_display_name
  - target.resource.name

# Outcome variables
risk_score: 75

event_count: count_distinct(gcp.metadata.id)

network_http_user_agent: array_distinct(gcp.network.http.user_agent)
principal_ip: array_distinct(gcp.principal.ip)
principal_ip_country: array_distinct(gcp.principal.ip_geo_artifact.location.country_or_region)
principal_ip_state: array_distinct(gcp.principal.ip_geo_artifact.location.state)

principal_user_id: gcp.principal.user.userid
principal_user_display_name: gcp.principal.user.user_display_name

target_resource_name: gcp.target.resource.name
event_name: gcp.metadata.product_event_type

# Condition
condition:
  - metadata.event_type = "USER_RESOURCE_UPDATE_PERMISSIONS"
  - metadata.log_type = "GCP_CLOUDAUDIT"
  - metadata.product_event_type = "SetIamPolicy"
  - security_result.action = "ALLOW"
  - target.application = "cloudresourcemanager.googleapis.com"
  - target.resource.attribute.labels.service_data_policy_delta_audit_config_delta_exempted_member_action = "ADD"
  - target.resource.attribute.labels.service_data_policy_delta_audit_config_delta_exempted_member_service = "allServices"