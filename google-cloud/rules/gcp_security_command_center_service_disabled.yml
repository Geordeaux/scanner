# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: GCP Security Command Center Service Disabled
description: |-
  ## Goal
  Detect when GCP Security Command Center services are disabled. This behavior may indicate an attempt to evade security monitoring and defense mechanisms, which could be malicious.

  ## Strategy
  Monitor Cloud Audit Logs for Update events related to Google Cloud Security Command Center settings where the service enablement state is set to DISABLED. Capture relevant details such as the event count, user information, and IP addresses involved, and set a high severity risk score to indicate the potential threat.

  ## Triage and Response
  Investigate the detected disable attempts to determine if they were authorized. Review the user and IP addresses involved to ensure that no unauthorized disabling of security services has occurred. Monitor for further suspicious activities involving this user or IP address.

enabled: true
severity: High

query_text: |-
  %ingest.source_type:gcp
  protoPayload.serviceName:securitycenter.googleapis.com
  protoPayload.methodName:google.cloud.securitycenter.settings*.Update*
  protoPayload.request:*DISABLED*
  | groupbycount(project_id, protoPayload.authenticationInfo.principalEmail)
  | where @q.count > 0

time_range_s: 3600      # Look back 1 hour
run_frequency_s: 300     # Run every 5 minutes

event_sink_keys:
  - high_severity_alerts

tags:
  - source.gcp
  - gcp
  - gcp_securitycenter
  - gcp_audit
  - security_command_center_disabled
  - techniques.t1562.impair_defenses
  - tactics.ta0005.defense_evasion

# Additional context fields for alert graph
context_fields:
  - project_id
  - protoPayload.authenticationInfo.principalEmail
  - protoPayload.requestMetadata.callerIp
  - protoPayload.serviceName
  - protoPayload.methodName
  - protoPayload.request
  - resource.type
  - resource.labels.project_id

# Outcome variables
risk_score: 75
event_count: "@q.count"