# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: GCP IAM Organization Policy Updated Or Deleted
description: |-
  ## Goal
  Detect when a GCP IAM Organization Policy is updated or deleted. This can indicate an attempt to manipulate account permissions, which can lead to unauthorized access and privilege escalation.

  ## Strategy
  Monitor GCP Cloud Audit logs for events where an IAM Organization Policy is either updated or deleted. Capture relevant details such as the principal IP, user, and target resource to assess potential threats. Set a high risk score to indicate the severity of this event.

  ## Triage and Response
  Investigate the detected event to determine if it was authorized. Review the principal IPs, users, and other details to ensure that no unauthorized actions have been taken. Ensure that all IAM policies are compliant with company policies.

enabled: true
severity: High

query_text: |-
  %ingest.source_type:gcp_audit
  metadata.log_type:"GCP_CLOUDAUDIT"
  target.application:"orgpolicy.googleapis.com"
  security_result.action:"ALLOW"
  metadata.event_type:(RESOURCE_WRITTEN RESOURCE_DELETION)
  metadata.product_event_type:(
    google.cloud.orgpolicy.v2.OrgPolicy.UpdatePolicy
    google.cloud.orgpolicy.v2.OrgPolicy.DeletePolicy
  )

time_range_s: 3600
run_frequency_s: 300

event_sink_keys:
  - high_severity_alerts

tags:
  - source.gcp
  - gcp_audit
  - gcp
  - iam_policy
  - iam_policy_violation
  - techniques.t1098.account_manipulation
  - tactics.ta0003.persistence
  - tactics.ta0004.privilege_escalation

# Additional context fields for alert graph
context_fields:
  - network.http.user_agent
  - principal.ip
  - principal.ip_geo_artifact.location.country_or_region
  - principal.ip_geo_artifact.location.state
  - principal.user.display_name
  - target.resource.name

# Outcome variables
risk_score: 75
event_count: count_distinct(gcp.metadata.id)

network_http_user_agent: array_distinct(gcp.network.http.user_agent)
principal_ip: array_distinct(gcp.principal.ip)
principal_ip_country: array_distinct(gcp.principal.ip_geo_artifact.location.country_or_region)
principal_ip_state: array_distinct(gcp.principal.ip_geo_artifact.location.state)

principal_user_id: gcp.principal.user.userid
principal_user_display_name: gcp.principal.user.display_name

target_resource_name: gcp.target.resource.name
event_name: gcp.metadata.product_event_type

# Condition (sanity checks on normalized fields)
condition:
  - metadata.log_type = "GCP_CLOUDAUDIT"
  - target.application = "orgpolicy.googleapis.com"
  - security_result.action = "ALLOW"