# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: GCP Firewall Rule Opened To The World
description: |-
  ## Goal
  Detect when a GCP Firewall rule is opened to the world (`0.0.0.0/0`) on all protocols. This can indicate an attempt to expose resources to the internet without proper restrictions, which increases the risk of unauthorized access.

  ## Strategy
  Monitor GCP Cloud Audit logs for events where a firewall rule is created that allows traffic from `0.0.0.0/0` on all protocols. Capture relevant details such as the principal IP, user, and target resource to assess potential threats. Set a high risk score to indicate the severity of this event.

  ## Triage and Response
  Investigate the detected event to determine if it was authorized. Review the principal IPs, users, and other details to ensure that no unauthorized actions have been taken. Ensure that all firewall rules are compliant with company policies.

enabled: true
severity: High

query_text: |-
  %ingest.source_type:gcp_audit
  metadata.event_type:RESOURCE_CREATION
  metadata.log_type:GCP_CLOUDAUDIT
  metadata.product_event_type:compute.firewalls.insert
  metadata.product_name:"Google Compute Engine"
  security_result.action:ALLOW
  target.resource.attribute.labels.source_ranges:"0.0.0.0/0"
  security_result.detection_fields.allowed_ipprotocol:all
  target.resource.attribute.labels.response_status:RUNNING

time_range_s: 3600
run_frequency_s: 300

event_sink_keys:
  - high_severity_alerts

tags:
  - gcp_audit
  - firewall_open_to_world
  - gcp
  - network
  - source.gcp
  - techniques.t1562.impair_defenses
  - tactics.ta0005.defense_evasion

# Additional context fields for alert graph
context_fields:
  - network.http.user_agent
  - principal.ip
  - principal.ip_geo_artifact.location.country_or_region
  - principal.ip_geo_artifact.location.state
  - principal.user.user_display_name
  - target.resource.name


# Outcome variables
risk_score: 75

event_count: count_distinct(gcp.metadata.id)

network_http_user_agent: array_distinct(gcp.network.http.user_agent)
principal_ip: array_distinct(gcp.principal.ip)
principal_ip_country: array_distinct(gcp.principal.ip_geo_artifact.location.country_or_region)
principal_ip_state: array_distinct(gcp.principal.ip_geo_artifact.location.state)

principal_user_id: gcp.principal.user.userid
principal_user_display_name: gcp.principal.user.user_display_name

target_resource_name: gcp.target.resource.name
event_name: gcp.metadata.product_event_type

# Condition
condition:
  - metadata.event_type = "RESOURCE_CREATION"
  - metadata.log_type = "GCP_CLOUDAUDIT"
  - metadata.product_event_type = "compute.firewalls.insert"
  - metadata.product_name = "Google Compute Engine"
  - security_result.action = "ALLOW"
  - target.resource.attribute.labels.source_ranges = "0.0.0.0/0"
  - security_result.detection_fields.allowed_ipprotocol = "all"
  - target.resource.attribute.labels.response_status = "RUNNING"