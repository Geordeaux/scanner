# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: GCP BigQuery Results Downloaded From Multiple Tables
description: |-
  ## Goal
  Detect when a user downloads GCP BigQuery results from multiple tables, which might indicate data exfiltration activity. This can be a sign of unauthorized data access and potential exfiltration.

  ## Strategy
  Monitor GCP Cloud Audit logs for events where the `jobservice.getqueryresults` action is taken on BigQuery datasets. Capture relevant details such as the principal IP, user, and target resources to assess potential threats. If a user downloads results from more than 3 distinct tables within an hour, trigger an alert.

  ## Triage and Response
  Investigate the detected event to determine if it was authorized. Review the principal IPs, users, and other details to ensure that no unauthorized data exfiltration has occurred. Ensure that all access policies comply with company policies.

enabled: true
severity: High

query_text: |-
  %ingest.source_type:gcp_audit
  metadata.event_type:USER_RESOURCE_ACCESS
  metadata.log_type:GCP_CLOUDAUDIT
  metadata.vendor_name:"Google Cloud Platform"
  metadata.product_name:BigQuery
  metadata.product_event_type:jobservice.getqueryresults
  security_result.action:ALLOW

time_range_s: 3600
run_frequency_s: 300

event_sink_keys:
  - high_severity_alerts

tags:
  - source.gcp
  - gcp_audit
  - bigquery_access
  - data_exfiltration
  - analytics
  - techniques.t1567.exfiltration_over_web_service
  - tactics.ta0010.exfiltration

# Additional context fields for enrichment + graph paths
context_fields:
  - network.http.user_agent
  - principal.ip
  - principal.ip_geo_artifact.location.country_or_region
  - principal.ip_geo_artifact.location.state
  - principal.user.user_display_name
  - target.resource.name

# Outcome variables
risk_score: max(75)

event_count: count_distinct(metadata.id)

network_http_user_agent: array_distinct(network.http.user_agent)
principal_ip: array_distinct(principal.ip)
principal_ip_country: array_distinct(principal.ip_geo_artifact.location.country_or_region)
principal_ip_state: array_distinct(principal.ip_geo_artifact.location.state)

principal_user_id: principal.user.userid
principal_user_display_name: principal.user.user_display_name

target_resource_name: array_distinct(target.resource.name)
event_name: metadata.product_event_type

bq_table_name: array_distinct(target.resource.name)
dc_bq_table_name: count_distinct(target.resource.name)

# Detection condition (CEL)
condition: dc_bq_table_name > 3