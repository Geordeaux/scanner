# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: GCP Excessive Permission Denied Events
description: |-
  ## Goal
  Detect excessive `PermissionDenied` events within an hour timeframe from a user. This can indicate reconnaissance activities where an actor is probing for available resources and permissions.

  ## Strategy
  Monitor GCP Cloud Audit logs for `PermissionDenied` events (`status_code = 7`) within a one-hour window. Capture relevant details such as the principal IP, user, and target resource to assess potential threats. If more than 5 such events are detected from the same user across different applications and event types within an hour, trigger an alert.

  ## Triage and Response
  Investigate the detected event to determine if it was authorized. Review the principal IPs, users, and other details to ensure that no unauthorized reconnaissance activities have occurred. Ensure that all access policies comply with company policies.

enabled: true
severity: Low

query_text: |-
  %ingest.source_type:gcp_audit
  metadata.log_type:GCP_CLOUDAUDIT
  security_result.action:BLOCK
  security_result.severity:ERROR
  security_result.detection_fields.status_code:7

time_range_s: 3600
run_frequency_s: 300

event_sink_keys:
  - low_severity_alerts

tags:
  - source.gcp
  - techniques.t1580.cloud_infrastructure_discovery
  - tactics.ta0007.discovery

# Additional context fields for alert graph
context_fields:
  - network.http.user_agent
  - principal.ip
  - principal.ip_geo_artifact.location.country_or_region
  - principal.ip_geo_artifact.location.state
  - principal.user.user_display_name
  - target.resource.name

# Outcome variables
risk_score: 35

event_count: count_distinct(gcp.metadata.id)

network_http_user_agent: array_distinct(gcp.network.http.user_agent)
principal_ip: array_distinct(gcp.principal.ip)
principal_ip_country: array_distinct(gcp.principal.ip_geo_artifact.location.country_or_region)
principal_ip_state: array_distinct(gcp.principal.ip_geo_artifact.location.state)
principal_user_display_name: array_distinct(gcp.principal.user.user_display_name)
target_resource_name: array_distinct(gcp.target.resource.name)

# Condition
condition:
  - count_distinct(gcp.metadata.id) > 5
  - count_distinct(gcp.target.application) > 1
  - count_distinct(gcp.metadata.product_event_type) > 1