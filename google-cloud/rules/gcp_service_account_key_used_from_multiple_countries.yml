# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json

name: GCP Service Account Key Used From Multiple Countries
description: |-
  ## Goal
  Detect when a Google Cloud service account key is used from multiple countries. This behavior may indicate unauthorized or malicious access to the service account, as legitimate use typically originates from a single location.

  ## Strategy
  Monitor Cloud Audit Logs for events where a service account key is used and capture the geographical information of the IP addresses involved. If more than two distinct countries are detected within an hour for the same service account key, trigger an alert.

  ## Triage and Response
  Investigate whether the geographic diversity of usage is expected. Review IP geolocation, user agents, and associated workloads. Validate whether the key is compromised or misused.

enabled: true
severity: Low

query_text: |-
  %ingest.source_type:gcp
  protoPayload.authenticationInfo.serviceAccountKeyName:*
  protoPayload.requestMetadata.callerIp_geo.country:*
  (not protoPayload.requestMetadata.callerIp_geo.organization:"Google")
  | groupbycount(protoPayload.authenticationInfo.serviceAccountKeyName, protoPayload.requestMetadata.callerIp_geo.country)
  | where @q.count_distinct_protoPayload_requestMetadata_callerIp_geo_country > 2

time_range_s: 3600
run_frequency_s: 300

event_sink_keys:
  - low_severity_alerts

tags:
  - source.gcp
  - gcp
  - gcp_iam
  - gcp_audit
  - service_account_key_multiple_countries
  - techniques.t1552.unsecured_credentials
  - tactics.ta0006.credential_access

# Additional context fields for alert graph
context_fields:
  - protoPayload.authenticationInfo.serviceAccountKeyName
  - protoPayload.authenticationInfo.principalEmail
  - protoPayload.requestMetadata.callerIp
  - protoPayload.requestMetadata.callerIp_geo.country
  - protoPayload.requestMetadata.callerIp_geo.state
  - protoPayload.requestMetadata.callerSuppliedUserAgent
  - resource.type
  - resource.labels.project_id

# Outcome variables
risk_score: 35
event_count: "@q.count"
countries_seen: "@q.count_distinct_protoPayload_requestMetadata_callerIp_geo_country"
service_account_key_name: protoPayload.authenticationInfo.serviceAccountKeyName