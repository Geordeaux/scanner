# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS GuardDuty Cryptocurrency Activity Detected
enabled: true
severity: High
description: |-
  ## Goal
  Detects when Amazon GuardDuty identifies cryptocurrency-related activity in Amazon EC2, AWS Lambda, or Amazon EKS runtimes. This could indicate an attempt to hijack resources for mining cryptocurrencies.

  ## Strategy
  Monitor GuardDuty findings for the detection of cryptocurrency activities (for example, finding types containing `CryptoCurrency`, `CryptoMinerExecuted`, or `BitcoinDomainRequest`). Capture relevant details such as the principal IP, user, and location to assess potential threats.

  ## Triage and response
  Investigate the detected cryptocurrency activity to determine if it was authorized. Review the user agent, principal IPs, and other details to assess potential threats. Ensure that no unauthorized resource hijacking is occurring.
query_text: |-
  %ingest.source_type="aws:guardduty"
  metadata.vendor_name:AMAZON
  metadata.product_name:"AWS GuardDuty"
  (
  metadata.product_event_type:*CryptoCurrency*
  or metadata.product_event_type:*CryptoMinerExecuted*
  or metadata.product_event_type:*BitcoinDomainRequest*
  )
  not security_result.about.labels.Sample:"true"
  | groupbycount(
  recipientAccountId,
  principal.ip,
  target.resource.product_object_id
  )
  | where @q.count > 0
time_range_s: 3600
run_frequency_s: 300
event_sink_keys:
- high_severity_alerts
tags:
- source.aws
- domain.cloud
- domain.guardduty
- tactics.ta0040.impact
- techniques.t1496.resource_hijacking
- use_case.aws_guardduty
- use_case.cryptomining
context_fields:
- recipientAccountId
- awsRegion
- principal.ip
- principal.ip_geo_artifact.location.country_or_region
- principal.ip_geo_artifact.location.state
- principal.user.user_display_name
- target.resource.name
- target.resource.product_object_id
- security_result.summary
- security_result.description
- security_result.severity
- security_result.severity_details
- metadata.product_event_type
risk_score: 35
event_count: count_distinct(metadata.id)
principal_ip: array_distinct(principal.ip)
principal_ip_country: array_distinct(principal.ip_geo_artifact.location.country_or_region)
principal_ip_state: array_distinct(principal.ip_geo_artifact.location.state)
principal_user_display_name: array_distinct(principal.user.user_display_name)
aws_region: array_distinct(awsRegion)
target_resource_name: array_distinct(target.resource.name)
target_resource_product_object_id: array_distinct(target.resource.product_object_id)
security_result_summary: array_distinct(security_result.summary)
security_result_description: array_distinct(security_result.description)
security_result_severity: array_distinct(security_result.severity)
security_result_severity_details: array_distinct(security_result.severity_details)
metadata_product_event_type: array_distinct(metadata.product_event_type)
