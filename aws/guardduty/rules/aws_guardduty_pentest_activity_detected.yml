# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS GuardDuty Penetration Testing Activity Detected
description: |-
  ## Goal
  Detects when Amazon GuardDuty identifies penetration testing activity from known offensive security distributions such as Kali Linux, Parrot Linux, or Pentoo Linux. This could indicate that an internal team is performing authorized penetration testing or that unauthorized actors are attempting to exploit the environment.

  ## Strategy
  Monitor GuardDuty findings for the detection of penetration testing activities (`PenTest`). Capture relevant details such as the principal IP, user, and location to assess potential threats.

  ## Triage and Response
  Investigate the detected penetration testing activity to determine if it was authorized. Review the principal IPs, users, and other details to ensure that no unauthorized testing is occurring. Ensure that all penetration testing activities are conducted in compliance with company policies.
enabled: true
severity: High
priority: High
query_text: |-
  %ingest.source_type:aws_guardduty
  metadata.vendor_name:AMAZON
  metadata.product_name:"AWS GuardDuty"
  metadata.product_event_type:/PenTest/
  not security_result.about.labels.Sample:true
time_range_s: 3600
run_frequency_s: 300
event_sink_keys:
- high_severity_alerts
tags:
- penetration_testing
- offensive_security
- guardduty
- aws
context_fields:
- principal.ip
- principal.ip_geo_artifact.location.country_or_region
- principal.ip_geo_artifact.location.state
- target.resource.name
- target.resource.product_object_id
- security_result.summary
- security_result.description
- security_result.severity
- security_result.severity_details
- metadata.product_event_type
mitre_attack_tactic: resource_development
mitre_attack_technique: obtain_capabilities
mitre_attack_technique_id: T1588
risk_score: max(35)
event_count: count_distinct(guardduty.metadata.id)
principal_ip: array_distinct(guardduty.principal.ip)
principal_ip_country: array_distinct(guardduty.principal.ip_geo_artifact.location.country_or_region)
principal_ip_state: array_distinct(guardduty.principal.ip_geo_artifact.location.state)
principal_user_display_name: guardduty.principal.user.user_display_name
aws_region: guardduty.target.location.name
target_resource_name: guardduty.target.resource.name
target_resource_product_object_id: guardduty.target.resource.product_object_id
security_result_summary: array_distinct(guardduty.security_result.summary)
security_result_description: array_distinct(guardduty.security_result.description)
security_result_severity: array_distinct(guardduty.security_result.severity)
security_result_severity_details: array_distinct(guardduty.security_result.severity_details)
metadata_product_event_type: array_distinct(guardduty.metadata.product_event_type)
condition:
- metadata.vendor_name = "AMAZON"
- metadata.product_name = "AWS GuardDuty"
- metadata.product_event_type =~ /PenTest/
- security_result.about.labels.Sample != "true"
