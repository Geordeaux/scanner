# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS Lateral Movement Using IAM Session Token
enabled: true
severity: Low
description: |-
  ## Goal
  Detect when an IAM session token is created and then used from a different IP address, indicating potential lateral movement.

  ## Strategy
  Monitor AWS CloudTrail management events where:
  * A session token is created via `GetSessionToken` (STS), and
  * The same access key ID is later used from a different source IP within the detection window.

  Because direct cross-event joins are limited, this rule approximates correlation by:
  * Looking at all `GetSessionToken` events and other events that contain an `accessKeyId` in the same time window.
  * Alerting when there is repeated use of the same `accessKeyId`, which can indicate reuse of a temporary session credential.

  ## Triage and Response
  * Confirm:
    * Who initiated the `GetSessionToken` request (`principal.user.user_display_name`, `userIdentity.arn`).
    * Whether the originating IP and subsequent IP(s) are expected (VPN egress, SSO proxies, bastion hosts, etc.).
  * Validate:
    * If MFA was used for the `GetSessionToken` request.
    * Whether the subsequent actions taken with the session token align with expected activity.
  * If suspicious:
    * Revoke or rotate associated credentials (user keys, roles).
    * Review all activity tied to the session access key across regions.
    * Hunt for related anomalous authentication or privilege escalation events.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  metadata.vendor_name:AMAZON
  metadata.product_name:"AWS CloudTrail"
  security_result.action:ALLOW
  (
  metadata.product_event_type:GetSessionToken or
  additional.fields.accessKeyId:*
  )
  | groupbycount(
  additional.fields.recipientAccountId,
  additional.fields.accessKeyId,
  principal.user.user_display_name,
  principal.ip
  )
  | where @q.count > 1
time_range_s: 3600
run_frequency_s: 3600
event_sink_keys:
- low_severity_alerts
tags:
- source.aws
- domain.cloud
- domain.iam
- tactics.ta0008.lateral_movement
- techniques.t1550.use_alternate_authentication_material
- use_case.session_token_lateral_movement
