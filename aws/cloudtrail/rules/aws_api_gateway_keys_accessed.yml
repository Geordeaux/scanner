# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS API Gateway Keys Accessed
enabled: true
severity: Low
description: |-
  ## Goal
  Detect when AWS API Gateway keys are accessed, particularly when their values are returned to the caller.

  ## Strategy
  Monitor AWS CloudTrail events for API Gateway management actions:
  * `GetApiKey` with `requestParameters.includeValue=true`
  * `GetApiKeys` with `requestParameters.includeValues=true`

  These actions may represent:
  * Legitimate operational inspection of API keys, or
  * Potential attempts to retrieve API key material for misuse, abuse of rate limits, or unauthorised access to protected APIs.

  ## Triage and Response
  * Identify the calling principal (userIdentity.arn, source IP, user agent) and confirm the activity against an approved change or operational task.
  * Determine whether the retrieved key(s) are associated with sensitive or high-value APIs (e.g. production, privileged admin APIs).
  * If access is not clearly justified, treat as potential key exposure: rotate the affected keys, review recent usage patterns, and investigate for related suspicious activity.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  eventSource="apigateway.amazonaws.com"
  eventName:(
  "GetApiKey"
  "GetApiKeys"
  )
  (
  requestParameters.includeValue=true or
  requestParameters.includeValues=true
  )
  and not errorCode:*
  | stats
  min(timestamp) as firstTime,
  max(timestamp) as lastTime,
  count() as eventCount
  by
  recipientAccountId,
  userIdentity.arn,
  eventSource,
  eventName,
  awsRegion
time_range_s: 3600
run_frequency_s: 300
event_sink_keys:
- low_severity_alerts
tags:
- source.aws
- domain.cloud
- tactics.ta0006.credential_access
- techniques.t1555.credentials_from_password_stores
- use_case.aws_apigw_keys
- use_case.governance
context_fields:
- recipientAccountId
- userIdentity.arn
- eventSource
- eventName
- awsRegion
- sourceIPAddress
- userAgent
- requestParameters.apiKey
- requestParameters.includeValue
- requestParameters.includeValues
- eventID
- eventTime
