# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS RDS Snapshot Shared Publicly
enabled: true
severity: High
description: |-
  ## Goal
  Detect when an Amazon RDS snapshot (either DB snapshot or DB cluster snapshot) is shared publicly. This could indicate an attempt to exfiltrate data by making the snapshot accessible to all users.

  ## Strategy
  Monitor AWS CloudTrail events from `rds.amazonaws.com` for the following API actions:
  * `ModifyDBSnapshotAttribute`
  * `ModifyDBClusterSnapshotAttribute`

  Identify events where:
  * `requestParameters.attributeName` is set to `restore`, and
  * `requestParameters.valuesToAdd.items` contains `all`

  This pattern indicates that the snapshot's restore permissions were updated to allow all AWS accounts (i.e. public sharing).

  ## Triage and Response
  * Confirm whether the snapshot was intended to be shared publicly (for example, a controlled data-sharing workflow) or if this was accidental/malicious.
  * Identify which snapshot was shared and what data it may contain (PII, secrets, financial data, etc.).
  * If unapproved, immediately revoke public access, rotate affected credentials, and review other RDS configuration changes performed by the same principal.
  * Search for access activity against the shared snapshot to assess potential data exfiltration.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  eventSource:"rds.amazonaws.com"
  eventName:(
  "ModifyDBSnapshotAttribute"
  "ModifyDBClusterSnapshotAttribute"
  )
  not errorCode:*
  requestParameters.attributeName:"restore"
  requestParameters.valuesToAdd.items:"all"
  | groupbycount(
  recipientAccountId,
  requestParameters.dBSnapshotIdentifier,
  userIdentity.arn,
  awsRegion
  )
  | where @q.count > 0
time_range_s: 3600
run_frequency_s: 3600
event_sink_keys:
- high_severity_alerts
tags:
- source.aws
- domain.cloud
- domain.rds
- tactics.ta0010.exfiltration
- techniques.t1537.transfer_data_to_cloud_account
- use_case.aws_rds
- use_case.data_exfiltration
context_fields:
- recipientAccountId
- awsRegion
- eventSource
- eventName
- eventTime
- sourceIPAddress
- userAgent
- userIdentity.type
- userIdentity.arn
- userIdentity.accountId
- requestParameters.dBSnapshotIdentifier
- requestParameters.dBClusterSnapshotIdentifier
- requestParameters.attributeName
- requestParameters.valuesToAdd.items
- additionalEventData
