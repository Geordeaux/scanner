# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS Unusual Number Of Failed Authentication Attempts From The Same IP
enabled: true
severity: Medium
description: |-
  ## Goal
  Detect when there are an unusual number (for example, more than 5) of failed authentication attempts from the same IP address for valid users within a 5-minute window. This can indicate a brute force attack or credential stuffing attempt.

  ## Strategy
  Monitor AWS CloudTrail sign-in events from `signin.amazonaws.com` where `eventName=ConsoleLogin` and the result is a failure. Exclude failures where no username is present (for example, `No username found in supplied account`) to focus on valid users. Aggregate these events over a 5-minute window and flag IP addresses with more than 5 failed attempts.

  ## Triage and Response
  * Confirm whether the source IP is expected for the affected users (VPN, office ranges, etc.).
  * Check whether any subsequent successful logins occurred from the same IP or for the same users.
  * If suspicious, temporarily block or rate-limit the source IP, and consider enforcing MFA or password resets for affected accounts.
  * Review other activity from the IP in CloudTrail, WAF, or other telemetry to identify broader malicious behavior.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  eventSource:"signin.amazonaws.com"
  eventName:ConsoleLogin
  responseElements.ConsoleLogin:"Failure"
  (not errorMessage:"No username found in supplied account")
  | groupbycount(
  sourceIPAddress,
  recipientAccountId
  )
  | where @q.count > 5
time_range_s: 300
run_frequency_s: 60
event_sink_keys:
- medium_severity_alerts
tags:
- source.aws
- domain.identity
- domain.authentication
- tactics.ta0006.credential_access
- techniques.t1110.brute_force
- use_case.aws_signin
context_fields:
- eventTime
- awsRegion
- recipientAccountId
- eventSource
- eventName
- userIdentity.type
- userIdentity.arn
- userIdentity.accountId
- sourceIPAddress
- userAgent
- responseElements.ConsoleLogin
- errorMessage
- additionalEventData
