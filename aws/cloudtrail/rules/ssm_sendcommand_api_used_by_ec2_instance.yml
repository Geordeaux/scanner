# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: SSM SendCommand API Used by EC2 Instance
enabled: true
severity: Medium
description: |-
  ## Goal
  An attacker with compromised EC2 instance credentials, may use those credentials to attempt remote code execution against the EC2 instance from which the credentials were compromised via SSM SendCommand API.

  ## Strategy
  An attacker with compromised EC2 instance credentials, may use those credentials to attempt remote code execution against the EC2 instance from which the credentials were compromised via SSM SendCommand API.

  ## Triage and Response
  Investigate and remediate as appropriate.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  eventSource="ssm.amazonaws.com"
  eventName="SendCommand"
  userIdentity.type="AssumedRole"
  userIdentity.principalId like "*:i-*"
  | groupbycount(userIdentity.arn)
  | where @q.count > 0
time_range_s: 3600
run_frequency_s: 300
event_sink_keys:
- medium_severity_alerts
tags:
- source.aws
- domain.cloud
- tactics.ta0002.execution
- techniques.t1059.command_and_scripting_interpreter
