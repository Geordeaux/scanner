# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS EC2 High Number Of API Calls
enabled: true
severity: Low
description: |-
  ## Goal
  Detects when an EC2 instance makes a high number of API calls within a short period. This can indicate reconnaissance activity, aggressive automation, or misconfigured tooling.

  ## Strategy
  Monitor AWS CloudTrail management events where the caller is an EC2 instance role (via an assumed role session whose principalId includes an EC2 instance ID).
  Aggregate events over a five-minute window and identify instances whose API call volume exceeds a defined threshold (for example, more than 50 API calls per instance per source IP in five minutes).

  ## Triage and Response
  * Confirm whether the instance and role are associated with a known application or scheduled job.
  * Validate that the observed API usage pattern matches the expected behaviour for that workload (for example, known inventory sync, backup, or discovery jobs).
  * Review recent changes (deployments, configuration changes, new tooling) that might explain the spike.
  * If activity is unexpected, treat as potential reconnaissance or compromised instance:
    * Capture additional telemetry (CloudTrail, VPC Flow Logs, EDR if present).
    * Assess the blast radius (what APIs and resources are being accessed).
    * Consider containment (instance quarantine, role credential revocation, or security group tightening) in line with your incident response plan.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  userIdentity.type:"AssumedRole"
  userIdentity.principalId:*i-*
  (not errorCode:*)
  | groupbycount(userIdentity.principalId, sourceIPAddress)
  | where @q.count > 50
time_range_s: 300
run_frequency_s: 300
event_sink_keys:
- low_severity_alerts
tags:
- source.aws
- domain.cloud
- domain.aws_ec2
- tactics.ta0007.discovery
- techniques.t1580.cloud_infrastructure_discovery
- use_case.ec2_reconnaissance
- use_case.anomalous_api_activity
context_fields:
- recipientAccountId
- awsRegion
- eventTime
- eventSource
- eventName
- requestParameters.instanceId
- responseElements.timestamp
- userIdentity.type
- userIdentity.arn
- userIdentity.accountId
- userIdentity.userName
- userIdentity.sessionContext.sessionIssuer.arn
- sourceIPAddress
- userAgent
- errorCode
- errorMessage
