# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS EC2 AMI Or Snapshot Shared Publicly
enabled: true
severity: High
description: |-
  ## Goal
  Detect when an Amazon EC2 AMI or Snapshot is shared publicly. Public sharing can lead to unauthorised access and potential data exfiltration.

  ## Strategy
  Monitor AWS CloudTrail management events from `ec2.amazonaws.com` with:
  * `eventName="ModifyImageAttribute"` (AMI)
  * `eventName="ModifySnapshotAttribute"` (EBS snapshot)

  Focus specifically on changes where launch or volume permissions are modified to include the `all` group, which makes the AMI or snapshot publicly accessible.

  ## Triage and Response
  * Identify whether the AMI or snapshot contains sensitive data (production images, database volumes, bastion images, etc.).
  * Confirm whether the public sharing aligns with an approved change request or documented publishing workflow.
  * Review recent activity from the same principal and source IP for related configuration changes (e.g. new snapshots, unusual copy or share operations).
  * If unapproved, treat as a high-priority exfiltration risk: revoke public access, preserve evidence, and assess for any access already made to the shared resource.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  eventSource="ec2.amazonaws.com"
  eventName:(
  "ModifyImageAttribute"
  "ModifySnapshotAttribute"
  )
  (
  requestParameters.launchPermission.add.items.group="all"
  or requestParameters.createVolumePermission.add.items.group="all"
  )
  | groupbycount(
  recipientAccountId,
  awsRegion,
  eventName,
  requestParameters.imageId,
  requestParameters.snapshotId,
  userIdentity.type,
  userIdentity.arn,
  sourceIPAddress
  )
  | where @q.count > 0
time_range_s: 3600
run_frequency_s: 300
event_sink_keys:
- high_severity_alerts
tags:
- source.aws
- domain.cloud
- domain.compute
- domain.storage
- domain.access_control
- tactics.ta0010.exfiltration
- techniques.t1537.transfer_data_to_cloud_account
- use_case.aws_ec2
- use_case.data_exposure
- use_case.public_sharing
context_fields:
- recipientAccountId
- awsRegion
- eventTime
- eventSource
- eventName
- requestParameters.imageId
- requestParameters.snapshotId
- requestParameters.launchPermission.add.items
- requestParameters.createVolumePermission.add.items
- userIdentity.type
- userIdentity.arn
- userIdentity.accountId
- userIdentity.userName
- userIdentity.sessionContext.sessionIssuer.arn
- sourceIPAddress
- userAgent
- errorCode
- errorMessage
