# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS API Call Outside Of Organisation
enabled: true
severity: High
description: |-
  ## Goal
  Detect API calls from AWS accounts that are not part of the approved AWS Organisation account set.

  ## Strategy
  Monitor AWS CloudTrail events and flag any API activity where the `recipientAccountId` (or equivalent account identifier) does not match a known, approved AWS account ID. This helps identify API calls originating from unmanaged, misconfigured, or potentially compromised accounts outside the organisation boundary.

  ## Triage and Response
  * Validate whether the account ID is truly unknown or has recently been on-boarded but not yet added to the approved list.
  * Confirm with the cloud/platform team whether the activity relates to legitimate testing, third-party services, or partner accounts.
  * If the account is confirmed as unauthorised, treat the activity as a potential compromise or misconfiguration and initiate the appropriate incident response playbook.

  Note: Update the list of approved AWS account IDs in the query before enabling this rule.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  and metadata.vendor_name:"AMAZON"
  and metadata.product_name:"AWS CloudTrail"
  and recipientAccountId:*
  and not recipientAccountId:(
  "<approved_account_id_1>" or
  "<approved_account_id_2>" or
  "<approved_account_id_3>"
  )
  | stats
  min(timestamp) as firstTime,
  max(timestamp) as lastTime,
  count() as eventCount
  by
  recipientAccountId,
  userIdentity.arn,
  eventSource,
  eventName,
  awsRegion
time_range_s: 3600
run_frequency_s: 300
event_sink_keys:
- high_severity_alerts
tags:
- source.aws
- domain.cloud
- tactics.ta0001.initial_access
- tactics.ta0003.persistence
- tactics.ta0004.privilege_escalation
- tactics.ta0005.defense_evasion
- techniques.t1133.external_remote_services
- use_case.aws_account_inventory
- use_case.governance
context_fields:
- recipientAccountId
- userIdentity.arn
- eventSource
- eventName
- awsRegion
- sourceIPAddress
- userAgent
- requestParameters
- responseElements
- eventID
- eventTime
