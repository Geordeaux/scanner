# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS Successful API From Tor Exit Node
enabled: true
severity: High
description: |-
  ## Goal
  Detect successful AWS API executions originating from Tor exit nodes, which may indicate attempts to execute malicious commands or access sensitive resources from anonymized IP addresses.

  ## Strategy
  Monitor AWS CloudTrail management events and flag successful API calls where the source IP has been enriched with threat intelligence identifying it as a Tor exit node. Use the GCTI Feed enrichment fields on events to identify Tor exit nodes.

  ## Triage and Response
  * Confirm whether the access from a Tor exit node is expected for the user and application (in most environments, it is not).
  * Review the API calls made from the Tor IP, including services, actions, and resources accessed.
  * Check user agent, authentication context (MFA, SSO, programmatic keys), and recent activity by the same principal and IP.
  * If suspicious, revoke or rotate credentials, tighten network/access controls, and consider blocking Tor exit nodes at the perimeter.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  metadata.vendor_name:AMAZON
  metadata.product_name:"AWS CloudTrail"
  security_result.action:ALLOW
  gcti_feed.graph.metadata.product_name:"GCTI Feed"
  gcti_feed.graph.metadata.threat.threat_feed_name:"Tor Exit Nodes"
  gcti_feed.graph.metadata.entity_type:IP_ADDRESS
  | groupbycount(
  principal.ip,
  principal.user.user_display_name,
  metadata.product_event_type
  )
  | where @q.count > 0
time_range_s: 300
run_frequency_s: 300
event_sink_keys:
- high_severity_alerts
tags:
- source.aws
- domain.cloud
- domain.network
- tactics.ta0002.execution
- techniques.t1204.user_execution
- use_case.tor_exit_node
- use_case.anonymous_access
context_fields:
- principal.ip
- principal.ip_geo_artifact.location.country_or_region
- principal.ip_geo_artifact.location.state
- principal.user.user_display_name
- network.http.user_agent
- extensions.auth.auth_details
- metadata.product_event_type
- eventTime
- sourceIPAddress
- userAgent
- userIdentity.type
- userIdentity.arn
- userIdentity.accountId
- target.resource.name
- target.resource.product_object_id
- gcti_feed.graph.metadata.product_name
- gcti_feed.graph.metadata.threat.threat_feed_name
