# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: AWS SAML Identity Provider Changes
enabled: true
severity: Medium
description: |-
  ## Goal
  Detect create, update, or delete events of a SAML provider in AWS. These actions can indicate potential security issues related to unauthorized access and manipulation of authentication mechanisms.

  ## Strategy
  Monitor AWS CloudTrail events for specific actions related to SAML identity providers:
  * `CreateSAMLProvider`
  * `UpdateSAMLProvider`
  * `DeleteSAMLProvider`

  ## Triage and Response
  * Confirm whether the SAML IdP change is part of an approved change request.
  * Review the new or updated SAML metadata, audience, and attribute mappings for correctness and least privilege.
  * Verify that the IdP is trusted and that no unexpected third-party or test IdPs have been added.
  * Review recent activity by the same principal for other IAM / federation configuration changes.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  eventSource:"iam.amazonaws.com"
  eventName:(
  CreateSAMLProvider
  UpdateSAMLProvider
  DeleteSAMLProvider
  )
  not errorCode:*
  | groupbycount(
  recipientAccountId,
  userIdentity.arn,
  awsRegion,
  eventName
  )
  | where @q.count > 0
time_range_s: 3600
run_frequency_s: 3600
event_sink_keys:
- medium_severity_alerts
tags:
- source.aws
- domain.cloud
- domain.iam
- domain.auth
- tactics.ta0001.initial_access
- tactics.ta0003.persistence
- tactics.ta0004.privilege_escalation
- tactics.ta0005.defense_evasion
- techniques.t1078.valid_accounts
- use_case.aws_iam
- use_case.saml_idp
context_fields:
- recipientAccountId
- awsRegion
- eventSource
- eventName
- eventTime
- sourceIPAddress
- userAgent
- userIdentity.type
- userIdentity.arn
- userIdentity.accountId
- requestParameters
- responseElements
