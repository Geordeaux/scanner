name: AWS IAM Activity From EC2 Instance Playbook
description: Detects AWS IAM activities performed by AWS EC2 instances, which can
  indicate an attempt to retain access or escalate privileges. This is a high-severity
  concern as it may indicate unauthorised actions being taken from EC2 instances.
severity: High
steps:
- name: Investigation
  description: "Monitor AWS CloudTrail management events where:\n* The service is\
    \ IAM (`iam.amazonaws.com`), and\n* The action is one of:\n  * `CreateUser`\n\
    \  * `AttachUserPolicy`\n  * `CreateLoginProfile`\n  * `UpdateLoginProfile`\n\
    \  * `CreateAccessKey`\n  * `CreateGroup`\n  * `AttachGroupPolicy`\n  * `CreateRole`\n\
    \  * `AttachRolePolicy`\n* The calling principal is an assumed role session whose\
    \ ARN pattern indicates usage from an EC2 instance profile (for example, `arn:aws:sts::<account-id>:assumed-role/<role-name>/i-0123456789abcdef`).\n\
    \nA single matching event is sufficient to generate an alert, as IAM account creation\
    \ and policy changes from EC2 instances are high-impact and often unexpected outside\
    \ of tightly controlled automation."
- name: Triage
  description: "* Identify the instance ID (from `userIdentity.arn`), IAM role, and\
    \ caller account.\n* Confirm whether:\n  * The instance is part of an approved\
    \ automation or control plane, and\n  * IAM-mutating actions from that instance\
    \ are explicitly expected.\n* If activity is not clearly expected:\n  * Treat\
    \ as potentially malicious persistence or privilege escalation.\n  * Review recent\
    \ activity for the same instance and role (new users, keys, policies, role assumptions).\n\
    \  * Consider:\n    * Revoking or restricting the instance role permissions.\n\
    \    * Stopping or isolating the instance.\n    * Rotating any newly created credentials.\n\
    * If confirmed legitimate, consider enforcing:\n  * Tighter IAM conditions (for\
    \ example, `aws:SourceIp`, `aws:SourceAccount`, or `aws:PrincipalTag`).\n  * Guardrails\
    \ that prevent interactive or ad-hoc IAM changes from EC2 instances."
