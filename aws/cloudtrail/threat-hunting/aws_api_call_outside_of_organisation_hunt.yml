# schema: https://scanner.dev/schema/scanner-threat-hunting-query.v1.json
name: AWS API Call Outside Of Organisation
description: |-
  Detect API calls from AWS accounts that are not part of the approved AWS Organisation account set.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  and metadata.vendor_name:"AMAZON"
  and metadata.product_name:"AWS CloudTrail"
  and recipientAccountId:*
  and not recipientAccountId:(
  "<approved_account_id_1>" or
  "<approved_account_id_2>" or
  "<approved_account_id_3>"
  )
  | stats
  min(timestamp) as firstTime,
  max(timestamp) as lastTime,
  count() as eventCount
  by
  recipientAccountId,
  userIdentity.arn,
  eventSource,
  eventName,
  awsRegion
tags:
- source.aws
- domain.cloud
- tactics.ta0001.initial_access
- tactics.ta0003.persistence
- tactics.ta0004.privilege_escalation
- tactics.ta0005.defense_evasion
- techniques.t1133.external_remote_services
- use_case.aws_account_inventory
- use_case.governance
