# schema: https://scanner.dev/schema/scanner-threat-hunting-query.v1.json
name: AWS Privilege Escalation Using IAM Login Profile
description: |-
  Detect when a user creates or updates a login profile for another user and then a successful AWS Console login is performed from the same IP address within a short time window. This can indicate an attempt to escalate privileges by unauthorized users.
query_text: |-
  %ingest.source_type="aws:cloudtrail"
  eventSource:("iam.amazonaws.com" "signin.amazonaws.com")
  (
  (
  eventSource:"iam.amazonaws.com"
  eventName:("CreateLoginProfile" "UpdateLoginProfile")
  )
  or
  (
  eventSource:"signin.amazonaws.com"
  eventName:"ConsoleLogin"
  responseElements.ConsoleLogin:"Success"
  )
  )
  not errorCode:*
  | groupbycount(
  recipientAccountId,
  sourceIPAddress
  )
  | where @q.count > 1
tags:
- source.aws
- domain.cloud
- domain.iam
- tactics.ta0003.persistence
- tactics.ta0004.privilege_escalation
- techniques.t1136.003.cloud_account
- use_case.aws_iam
- use_case.privilege_escalation
