# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: GitHub TTB High Diversity Anomaly
enabled: true
description: |-
  ## Goal
  Detects anomalous high-velocity behavior where a single principal interacts with a high number of distinct Repositories and performs a high number of distinct Actions within a short time window.

  ## Strategy
  This rule utilizes the Time-Terrain-Behavior (TTB) framework:
  - **Time**: Short 5-minute window to detect bursts of activity.
  - **Terrain**: Diversity of Repositories (repository.name).
  - **Behavior**: Diversity of Actions (action).

  High diversity across these dimensions is often indicative of automated tools, reconnaissance scripts, or frantic manual exploitation.

  ## Time - Terrain - Behaviour
  - **Time**:
      - Lookback window: 300 seconds
      - Run frequency: 300 seconds
  - **Terrain**:
      - Log source: github
      - Key field: repository.name
      - Threshold: > 4 distinct values
  - **Behavior**:
      - Key field: action
      - Threshold: > 8 distinct values

  ## Triage and Response
  1. **Identify the Principal**: actor.
  2. **Analyze the Activity**: Use the linked TTB Notebook to visualize the user's activity in 3D space.
  3. **Contextualize**: Is this a service account running a scheduled job? (If so, tune the rule). Is this a user performing a bulk operation?
  4. **Verify**: Check if the actions performed are sensitive (e.g., downloading data, modifying permissions).
  5. **Remediate**: If malicious, suspend the user/revoke credentials.
severity: Medium
query_text: |-
  %ingest.source_type="github"
  | stats
    distinct_count(repository.name) as terrain_score,
    distinct_count(action) as behavior_score
    by actor
  | where terrain_score > 4 AND behavior_score > 8
time_range_s: 300
run_frequency_s: 300
event_sink_keys:
- medium_severity_alerts
tags:
- source.github
- ttb.anomaly
- exfiltration
alert_template:
  info:
  - label: Detection
    value: '{{@alert.name}}'
  - label: Severity
    value: '{{@alert.severity_id}}'
  - label: Principal
    value: '{{@alert.results_table.rows[0].actor}}'
  - label: Terrain Score
    value: '{{@alert.results_table.rows[0].terrain_score}}'
  - label: Behavior Score
    value: '{{@alert.results_table.rows[0].behavior_score}}'
  actions:
  - label: Open Detection
    value: https://scanner.dev/detections/{{@alert.id}}
  - label: Runbook
    value: https://runbooks.scanner.dev/ttb-investigation
tests:
- name: Test positive case - High Diversity
  now_timestamp: '2024-08-21T00:03:00.000Z'
  dataset_inline: |-
    {"actor": "octocat", "repository": {"name": "hello-world"}, "action": "clone"}
  expected_detection_result: true
- name: Test negative case - Low Diversity
  now_timestamp: '2024-08-21T00:03:00.000Z'
  dataset_inline: |-
    {"actor": "octocat", "repository": {"name": "hello-world"}, "action": "clone"}
  expected_detection_result: false
