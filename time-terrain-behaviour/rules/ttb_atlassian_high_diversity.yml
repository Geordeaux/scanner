# schema: https://scanner.dev/schema/scanner-detection-rule.v1.json
name: Atlassian TTB High Diversity Anomaly
enabled: true
description: |-
  ## Goal
  Detects anomalous high-velocity behavior where a single principal interacts with a high number of distinct Products/Sources and performs a high number of distinct Event Keys within a short time window.

  ## Strategy
  This rule utilizes the Time-Terrain-Behavior (TTB) framework:
  - **Time**: Short 5-minute window to detect bursts of activity.
  - **Terrain**: Diversity of Products/Sources (event_source).
  - **Behavior**: Diversity of Event Keys (event_key).

  High diversity across these dimensions is often indicative of automated tools, reconnaissance scripts, or frantic manual exploitation.

  ## Time - Terrain - Behaviour
  - **Time**:
      - Lookback window: 300 seconds
      - Run frequency: 300 seconds
  - **Terrain**:
      - Log source: atlassian
      - Key field: event_source
      - Threshold: > 2 distinct values
  - **Behavior**:
      - Key field: event_key
      - Threshold: > 6 distinct values

  ## Triage and Response
  1. **Identify the Principal**: actor.displayName.
  2. **Analyze the Activity**: Use the linked TTB Notebook to visualize the user's activity in 3D space.
  3. **Contextualize**: Is this a service account running a scheduled job? (If so, tune the rule). Is this a user performing a bulk operation?
  4. **Verify**: Check if the actions performed are sensitive (e.g., downloading data, modifying permissions).
  5. **Remediate**: If malicious, suspend the user/revoke credentials.
severity: Medium
query_text: |-
  %ingest.source_type="atlassian"
  | stats
    distinct_count(event_source) as terrain_score,
    distinct_count(event_key) as behavior_score
    by actor.displayName
  | where terrain_score > 2 AND behavior_score > 6
time_range_s: 300
run_frequency_s: 300
event_sink_keys:
- medium_severity_alerts
tags:
- source.atlassian
- ttb.anomaly
- defense_evasion
alert_template:
  info:
  - label: Detection
    value: '{{@alert.name}}'
  - label: Severity
    value: '{{@alert.severity_id}}'
  - label: Principal
    value: '{{@alert.results_table.rows[0].actor.displayName}}'
  - label: Terrain Score
    value: '{{@alert.results_table.rows[0].terrain_score}}'
  - label: Behavior Score
    value: '{{@alert.results_table.rows[0].behavior_score}}'
  actions:
  - label: Open Detection
    value: https://scanner.dev/detections/{{@alert.id}}
  - label: Runbook
    value: https://runbooks.scanner.dev/ttb-investigation
tests:
- name: Test positive case - High Diversity
  now_timestamp: '2024-08-21T00:03:00.000Z'
  dataset_inline: |-
    {"actor": {"displayName": "User"}, "event_source": "confluence", "event_key": "page_view"}
  expected_detection_result: true
- name: Test negative case - Low Diversity
  now_timestamp: '2024-08-21T00:03:00.000Z'
  dataset_inline: |-
    {"actor": {"displayName": "User"}, "event_source": "confluence", "event_key": "page_view"}
  expected_detection_result: false
